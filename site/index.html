<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="../static/bootstrap.min@v5.3.3.css" rel="stylesheet" />
  <script defer src="../static/htmx.org@1.9.10.js"></script>
  <script>
    const zsv = JSON.parse('{"v0.3.6-alpha":{"global_flags":[{"name":"-L,--limit-rows","argument":"\u003cn\u003e"},{"name":"-c,--max-column-count","argument":"\u003cn\u003e"},{"name":"-r,--max-row-size","argument":"\u003cn\u003e"},{"name":"-B,--buff-size","argument":"\u003cn\u003e"},{"name":"-t,--tab-delim"},{"name":"-O,--other-delim","argument":"\u003cchar\u003e"},{"name":"-q,--no-quote"},{"name":"-R,--skip-head","argument":"\u003cn\u003e"},{"name":"-d,--header-row-span","argument":"\u003cn\u003e"},{"name":"-u,--malformed-utf8-replacement","argument":"\u003creplacement_string\u003e"},{"name":"-S,--keep-blank-headers"},{"name":"-0,--header-row","argument":"\u003cheader\u003e"},{"name":"-v,--verbose"}],"commands":[{"name":"select","flags":[{"name":"-b,--with-bom"},{"name":"--fixed","argument":"\u003coffset1,offset2,..\u003e"},{"name":"--fixed-auto"},{"name":"-H,--head","argument":"\u003cn\u003e"},{"name":"-s,--search","argument":"\u003cvalue\u003e"},{"name":"--sample-every","argument":"\u003cnum_of_rows\u003e"},{"name":"--sample-pct","argument":"\u003cpercentage\u003e"},{"name":"--distinct"},{"name":"--merge"},{"name":"-e","argument":"\u003cembedded_lineend_char\u003e"},{"name":"-x","argument":"\u003ccolumn\u003e"},{"name":"-N,--line-number"},{"name":"-n"},{"name":"--unescape"},{"name":"-w,--whitespace-clean"},{"name":"--whitespace-clean-no-newline"},{"name":"-W,--no-trim"}]},{"name":"echo","flags":[{"name":"-b"},{"name":"--overwrite","argument":"\u003csource\u003e"}]},{"name":"sql","flags":[{"name":"--join-indexes","argument":"\u003cn1...\u003e"},{"name":"-b"},{"name":"-C,--max-cols","argument":"\u003cn\u003e"},{"name":"--memory"}]},{"name":"count"},{"name":"desc","flags":[{"name":"-b,--with-bom"},{"name":"-C","argument":"\u003cmaximum_number_of_columns\u003e"},{"name":"-H"},{"name":"-q,--quick"},{"name":"-a,--all"}]},{"name":"pretty","flags":[{"name":"-W,--width","argument":"\u003cn\u003e"},{"name":"-p,--rows"},{"name":"-C,--max-col-width","argument":"\u003cn\u003e"},{"name":"-D,--min-col-width","argument":"\u003cn\u003e"},{"name":"-A,--no-align"},{"name":"-m,--markdown"},{"name":"-M,--markdown-pad"},{"name":"-H,--ignore-header-lengths"}]},{"name":"flatten","flags":[{"name":"-b"},{"name":"-v,--verbose"},{"name":"-C","argument":"\u003cmax_columns_to_output\u003e"},{"name":"-m","argument":"\u003cmax_rows_per_aggregation\u003e"},{"name":"--row-id","argument":"\u003crow_id_column_name\u003e"},{"name":"--col-name","argument":"\u003ccolumn_id_column_name\u003e"},{"name":"-V","argument":"\u003cvalue_column_name\u003e"}]},{"name":"2json","flags":[{"name":"--compact"},{"name":"--from-db"},{"name":"--db-table","argument":"\u003ctable_name\u003e"},{"name":"--object"},{"name":"--no-empty"},{"name":"--database"},{"name":"--no-header"},{"name":"--index","argument":"\u003cname_on_expr\u003e"},{"name":"--unique-index","argument":"\u003cname_on_expr\u003e"}]},{"name":"2tsv"},{"name":"serialize","flags":[{"name":"-b"},{"name":"-f,--filter","argument":"\u003cvalue\u003e"},{"name":"-e,--entire"},{"name":"-i,--case-insensitive"},{"name":"-p,--position"},{"name":"-a,--add","argument":"\u003ccolumn_name\u003e"}]},{"name":"stack","flags":[{"name":"-b"},{"name":"-q"},{"name":"-T"}]},{"name":"compare","flags":[{"name":"-k,--key","argument":"\u003cfield\u003e"},{"name":"-a,--add","argument":"\u003cfield\u003e"},{"name":"--sort"},{"name":"--sort-in-memory"},{"name":"--json"},{"name":"--json-compact"},{"name":"--json-object"}]}]},"v0.3.7-alpha":{"global_flags":[{"name":"-L,--limit-rows","argument":"\u003cn\u003e"},{"name":"-c,--max-column-count","argument":"\u003cn\u003e"},{"name":"-r,--max-row-size","argument":"\u003cn\u003e"},{"name":"-B,--buff-size","argument":"\u003cn\u003e"},{"name":"-t,--tab-delim"},{"name":"-O,--other-delim","argument":"\u003cchar\u003e"},{"name":"-q,--no-quote"},{"name":"-R,--skip-head","argument":"\u003cn\u003e"},{"name":"-d,--header-row-span","argument":"\u003cn\u003e"},{"name":"-u,--malformed-utf8-replacement","argument":"\u003creplacement_string\u003e"},{"name":"-S,--keep-blank-headers"},{"name":"-0,--header-row","argument":"\u003cheader\u003e"},{"name":"-v,--verbose"}],"commands":[{"name":"select","flags":[{"name":"-b,--with-bom"},{"name":"--fixed","argument":"\u003coffset1,offset2,..\u003e"},{"name":"--fixed-auto"},{"name":"-H,--head","argument":"\u003cn\u003e"},{"name":"--no-header"},{"name":"--prepend-header","argument":"\u003cvalue\u003e"},{"name":"-s,--search","argument":"\u003cvalue\u003e"},{"name":"--sample-every","argument":"\u003cnum_of_rows\u003e"},{"name":"--sample-pct","argument":"\u003cpercentage\u003e"},{"name":"--distinct"},{"name":"--merge"},{"name":"-e","argument":"\u003cembedded_lineend_char\u003e"},{"name":"-x","argument":"\u003ccolumn\u003e"},{"name":"-N,--line-number"},{"name":"-n"},{"name":"--unescape"},{"name":"-w,--whitespace-clean"},{"name":"--whitespace-clean-no-newline"},{"name":"-W,--no-trim"}]},{"name":"echo","flags":[{"name":"-b"},{"name":"--overwrite","argument":"\u003csource\u003e"}]},{"name":"sql","flags":[{"name":"--join-indexes","argument":"\u003cn1...\u003e"},{"name":"-b"},{"name":"-C,--max-cols","argument":"\u003cn\u003e"},{"name":"--memory"}]},{"name":"count"},{"name":"desc","flags":[{"name":"-b,--with-bom"},{"name":"-C","argument":"\u003cmaximum_number_of_columns\u003e"},{"name":"-H"},{"name":"-q,--quick"},{"name":"-a,--all"}]},{"name":"pretty","flags":[{"name":"-W,--width","argument":"\u003cn\u003e"},{"name":"-p,--rows"},{"name":"-C,--max-col-width","argument":"\u003cn\u003e"},{"name":"-D,--min-col-width","argument":"\u003cn\u003e"},{"name":"-A,--no-align"},{"name":"-m,--markdown"},{"name":"-M,--markdown-pad"},{"name":"-H,--ignore-header-lengths"}]},{"name":"flatten","flags":[{"name":"-b"},{"name":"-v,--verbose"},{"name":"-C","argument":"\u003cmax_columns_to_output\u003e"},{"name":"-m","argument":"\u003cmax_rows_per_aggregation\u003e"},{"name":"--row-id","argument":"\u003crow_id_column_name\u003e"},{"name":"--col-name","argument":"\u003ccolumn_id_column_name\u003e"},{"name":"-V","argument":"\u003cvalue_column_name\u003e"}]},{"name":"2json","flags":[{"name":"--compact"},{"name":"--from-db"},{"name":"--db-table","argument":"\u003ctable_name\u003e"},{"name":"--object"},{"name":"--no-empty"},{"name":"--database"},{"name":"--no-header"},{"name":"--index","argument":"\u003cname_on_expr\u003e"},{"name":"--unique-index","argument":"\u003cname_on_expr\u003e"}]},{"name":"2tsv"},{"name":"serialize","flags":[{"name":"-b"},{"name":"-f,--filter","argument":"\u003cvalue\u003e"},{"name":"-e,--entire"},{"name":"-i,--case-insensitive"},{"name":"-p,--position"},{"name":"-a,--add","argument":"\u003ccolumn_name\u003e"}]},{"name":"stack","flags":[{"name":"-b"},{"name":"-q"},{"name":"-T"}]},{"name":"compare","flags":[{"name":"-k,--key","argument":"\u003cfield\u003e"},{"name":"-a,--add","argument":"\u003cfield\u003e"},{"name":"--sort"},{"name":"--sort-in-memory"},{"name":"--json"},{"name":"--json-compact"},{"name":"--json-object"}]}]},"v0.3.8-alpha":{"global_flags":[{"name":"-L,--limit-rows","argument":"\u003cn\u003e"},{"name":"-c,--max-column-count","argument":"\u003cn\u003e"},{"name":"-r,--max-row-size","argument":"\u003cn\u003e"},{"name":"-B,--buff-size","argument":"\u003cn\u003e"},{"name":"-t,--tab-delim"},{"name":"-O,--other-delim","argument":"\u003cchar\u003e"},{"name":"-q,--no-quote"},{"name":"-R,--skip-head","argument":"\u003cn\u003e"},{"name":"-d,--header-row-span","argument":"\u003cn\u003e"},{"name":"-u,--malformed-utf8-replacement","argument":"\u003creplacement_string\u003e"},{"name":"-S,--keep-blank-headers"},{"name":"-0,--header-row","argument":"\u003cheader\u003e"},{"name":"-v,--verbose"}],"commands":[{"name":"select","flags":[{"name":"-b,--with-bom"},{"name":"--fixed","argument":"\u003coffset1,offset2,..\u003e"},{"name":"--fixed-auto"},{"name":"-H,--head","argument":"\u003cn\u003e"},{"name":"--no-header"},{"name":"--prepend-header","argument":"\u003cvalue\u003e"},{"name":"-s,--search","argument":"\u003cvalue\u003e"},{"name":"--sample-every","argument":"\u003cnum_of_rows\u003e"},{"name":"--sample-pct","argument":"\u003cpercentage\u003e"},{"name":"--distinct"},{"name":"--merge"},{"name":"-e","argument":"\u003cembedded_lineend_char\u003e"},{"name":"-x","argument":"\u003ccolumn\u003e"},{"name":"-N,--line-number"},{"name":"-n"},{"name":"--unescape"},{"name":"-w,--whitespace-clean"},{"name":"--whitespace-clean-no-newline"},{"name":"-W,--no-trim"}]},{"name":"echo","flags":[{"name":"-b"},{"name":"--overwrite","argument":"\u003csource\u003e"}]},{"name":"sql","flags":[{"name":"--join-indexes","argument":"\u003cn1...\u003e"},{"name":"-b"},{"name":"-C,--max-cols","argument":"\u003cn\u003e"},{"name":"--memory"}]},{"name":"count"},{"name":"desc","flags":[{"name":"-b,--with-bom"},{"name":"-C","argument":"\u003cmaximum_number_of_columns\u003e"},{"name":"-H"},{"name":"-q,--quick"},{"name":"-a,--all"}]},{"name":"pretty","flags":[{"name":"-W,--width","argument":"\u003cn\u003e"},{"name":"-p,--rows"},{"name":"-C,--max-col-width","argument":"\u003cn\u003e"},{"name":"-D,--min-col-width","argument":"\u003cn\u003e"},{"name":"-A,--no-align"},{"name":"-m,--markdown"},{"name":"-M,--markdown-pad"},{"name":"-H,--ignore-header-lengths"}]},{"name":"flatten","flags":[{"name":"-b"},{"name":"-v,--verbose"},{"name":"-C","argument":"\u003cmax_columns_to_output\u003e"},{"name":"-m","argument":"\u003cmax_rows_per_aggregation\u003e"},{"name":"--row-id","argument":"\u003crow_id_column_name\u003e"},{"name":"--col-name","argument":"\u003ccolumn_id_column_name\u003e"},{"name":"-V","argument":"\u003cvalue_column_name\u003e"}]},{"name":"2json","flags":[{"name":"--compact"},{"name":"--from-db"},{"name":"--db-table","argument":"\u003ctable_name\u003e"},{"name":"--object"},{"name":"--no-empty"},{"name":"--database"},{"name":"--no-header"},{"name":"--index","argument":"\u003cname_on_expr\u003e"},{"name":"--unique-index","argument":"\u003cname_on_expr\u003e"}]},{"name":"2tsv"},{"name":"serialize","flags":[{"name":"-b"},{"name":"-f,--filter","argument":"\u003cvalue\u003e"},{"name":"-e,--entire"},{"name":"-i,--case-insensitive"},{"name":"--id-column","argument":"\u003cn\u003e"},{"name":"-p,--position"},{"name":"-a,--add","argument":"\u003ccolumn_name\u003e"}]},{"name":"stack","flags":[{"name":"-b"},{"name":"-q"},{"name":"-T"}]},{"name":"compare","flags":[{"name":"-k,--key","argument":"\u003cfield\u003e"},{"name":"-a,--add","argument":"\u003cfield\u003e"},{"name":"--sort"},{"name":"--sort-in-memory"},{"name":"--json"},{"name":"--json-compact"},{"name":"--json-object"}]}]}}');

    function populateCommands(event) {
      document.getElementById("commands").innerHTML = "";
      document.getElementById("flags").innerHTML = "";
      document.getElementById("cli").value = "zsv";
      const version = document.getElementById("version").value;
      if (zsv[version] !== undefined) {
        const commands = zsv[version]["commands"];
        if (commands.length !== 0) {
          var commandsHTML = [
            "<option value='' selected>Select command</option>",
          ];
          for (let command of commands) {
            commandsHTML.push(`"<option value='${command.name}'>${command.name}</option>"`);
          }
          document.getElementById("commands").innerHTML = commandsHTML.join("");
        }
      }
    }

    function normalizeFlagName(name) {
      return name.replace(/-|,/g, "");
    }

    function populateFlags(command) {
      const version = document.getElementById("version").value;
      if (version === "") {
        document.getElementById("flags").innerHTML = "";
        return;
      }

      var flagsHTML = [];
      const globalFlags = zsv[version]["global_flags"];
      for (let flag of globalFlags) {
        const id = normalizeFlagName(flag.name);
        f = `
          <div class="input-group mb-0">
            <div class="input-group-text">
              <input id="flag_${id}" value="${flag.name}" class="form-check-input" type="checkbox" onchange="handleFlag(event);" />
            </div>
            <span class="form-control input-group-text w-50">${flag.name}</span>
        `;
        if (flag.argument !== undefined) {
          f += `<input id="flag_${id}_value" type="text" class="form-control" placeholder="${flag.argument}" onkeyup="handleFlagValue(event);" onkeydown="handleKeyDown(event);" />`;
        }
        f += '</div>';
        flagsHTML.push(f);
      }

      const commands = zsv[version]["commands"];
      const commandFound = commands.find(cmd => cmd.name === command);
      if (commandFound["flags"] !== undefined) {
        for (let flag of commandFound["flags"]) {
          const id = normalizeFlagName(flag.name);
          var f = `
            <div class="input-group mb-0">
              <div class="input-group-text">
                <input id="flag_${id}" value="${flag.name}" class="form-check-input" type="checkbox" onchange="handleFlag(event);" />
              </div>
              <span class="form-control input-group-text w-50">${flag.name}</span>
          `;
          if (flag.argument !== undefined) {
            f += `<input id="flag_${id}_value" type="text" class="form-control" placeholder="${flag.argument}" onkeyup="handleFlagValue(event);" onkeydown="handleKeyDown(event);" />`;
          }
          f += '</div>';
          flagsHTML.push(f);
        }
      }
      document.getElementById("flags").innerHTML = flagsHTML.join("");
    }

    function updateCLI(command) {
      document.getElementById("cli").value = "zsv " + command;
    }

    function handleCommand() {
      const command = document.getElementById("commands").value;
      if (command === "") {
        document.getElementById("flags").innerHTML = "";
        document.getElementById("cli").value = "zsv";
        return;
      }
      updateCLI(command);
      populateFlags(command);
    }

    function updateCLIWithFlag(checked, flag, value) {
      var cli = document.getElementById("cli").value.split(" ");
      if (checked === true) {
        if (value === "") {
          cli.push(flag);
        } else {
          const i = cli.indexOf(flag);
          if (i === -1) {
            cli.push(flag, value);
          } else {
            cli[i + 1] = value;
          }
        }
      } else {
        const i = cli.indexOf(flag);
        if (value === "") {
          cli.splice(i, 1);
        } else {
          cli.splice(i, 2);
        }
      }
      document.getElementById("cli").value = cli.join(" ");
    }

    function handleFlag(event) {
      const flagId = event.target.id;
      const flagName = event.target.value;
      const flagValue = document.getElementById(flagId + "_value");
      var flag = flagName;
      if (flag.indexOf(",") !== -1) {
        flag = flag.substring(0, flag.indexOf(","));
      }

      var value = "";
      if (flagValue !== null) {
        if (flagValue.value !== "") {
          value = `'${flagValue.value}'`;
        } else {
          value = `''`;
        }
      }
      updateCLIWithFlag(event.target.checked, flag, value);
    }

    function handleFlagValue(event) {
      const valueId = event.target.id;
      const flagValue = event.target.value;
      const flagId = valueId.replace("_value", "");
      const flagObject = document.getElementById(flagId);
      const checked = flagObject.checked;
      var flag = flagObject.value;
      if (flag.indexOf(",") !== -1) {
        flag = flag.substring(0, flag.indexOf(","));
      }
      var value = "";
      if (flagValue !== "") {
        value = `'${flagValue}'`;
      } else {
        value = `''`;
      }
      if (checked === true) {
        updateCLIWithFlag(checked, flag, value);
      }
    }

    function handleKeyDown(event) {
      if (event.code === "Space") {
        event.preventDefault();
        return false;
      }
    }

    // htmx.logger = function (elt, event, data) {
    //   if (console) {
    //     console.log(event, elt, data);
    //   }
    // };

    window.addEventListener("DOMContentLoaded", (event) => {
      const form = document.getElementById('form');
      if (form) {
        form.addEventListener('htmx:sendError', function (event) {
          const error = "[ERR] Server error! Make sure server is up and running!";
          console.error(error);
          document.getElementById('result').innerText = error;
        });
      }
    });
  </script>
  <title>zsv playground v0.0.1</title>
</head>

<body class="p-3 mt-3 font-monospace">
  <div class="container">
    <div class="text-center text-bg-primary rounded-2 fs-3">
      zsv playground
      <span class="badge badge-dark">v0.0.1</span>
    </div>

    <!-- version -->
    <div class="row mt-4 mb-4 text-center">
      <div class="col-12">
        <select id="version" class="form-select w-25 mx-auto text-center" required onchange="populateCommands(event);">
          <option value="" selected>Select zsv version</option>
          <option value="v0.3.8-alpha">zsv v0.3.8-alpha</option>
          <option value="v0.3.7-alpha">zsv v0.3.7-alpha</option>
          <option value="v0.3.6-alpha">zsv v0.3.6-alpha</option>
        </select>
      </div>
    </div>

    <form id="form" class="form" method="post" action="#">
      <div class="row mb-3 flex-nowrap">
        <!-- commands -->
        <div class="col-3">
          <select id="commands" class="form-select overflow-auto" size="7" required onchange="handleCommand();">
          </select>
        </div>

        <!-- flags -->
        <div class="col-9">
          <div id="flags" class="list-group overflow-auto p-2 border" style="max-height: 150px; height: 150px;">
            <div class="input-group">
              <div class="input-group-text">
                <input id="flag_Bboolean" class="form-check-input" type="checkbox" value="-B,--boolean"
                  onchange="handleFlag(event);" />
              </div>
              <span class="form-control input-group-text">-B,--boolean</span>
            </div>
            <div class="input-group mb-3">
              <div class="input-group-text">
                <input id="flag_Vvalue" class="form-check-input" type="checkbox" value="-V,--value"
                  onchange="handleFlag(event);" />
              </div>
              <span class="form-control input-group-text w-50">-V,--value</span>
              <input id="flag_Vvalue_value" type="text" class="form-control" placeholder="<value>"
                onkeyup="handleFlagValue(event);" onkeydown="handleKeyDown(event);" />
            </div>
          </div>
        </div>
      </div>

      <!-- cli -->
      <div class="row">
        <div class="input-group">
          <input id="cli" name="cli" type="text" class="form-control bg-light" value="zsv" readonly />
          <button id="run" class="btn btn-outline-primary" type="submit">Run</button>
        </div>
      </div>

      <!-- input and output -->
      <div class="row mt-3">
        <div class="col-6">
          <label for="csv" class="form-label">CSV</label>
          <textarea id="csv" name="csv" class="form-control"
            style="height: 400px; max-height: 400px; resize: none; white-space: nowrap;" required></textarea>
        </div>
        <div class="col-6">
          <label for="result" class="form-label">Result</label>
          <pre id="result" class="form-control bg-light overflow-auto" style="height: 400px; resize: none;"></pre>
        </div>
      </div>
    </form>

    <!-- GitHub repo link -->
    <div class="row mt-4 mb-4 text-center">
      <div class="col-12">
        <span class="w-25 mx-auto text-center">
          <a href="https://github.com/iamazeem/zsv-playground">GitHub</a>
        </span>
      </div>
    </div>
  </div>
</body>

</html>
