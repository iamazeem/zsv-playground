<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="../static/bootstrap.min@v5.3.3.css" rel="stylesheet" />
  <script defer src="../static/htmx.org@1.9.10.js"></script>
  <style>
    textarea {
      height: 400px;
      resize: none;
      white-space: nowrap;
    }
  </style>
  <script>
    const zsv = {
      "v0.3.8-alpha": {
        "global_flags": [
          { "name": "-L,--limit-rows", "argument": "<n>" },
          { "name": "-c,--max-column-count", "argument": "<n>" },
          { "name": "-r,--max-row-size", "argument": "<n>" },
          { "name": "-B,--buff-size", "argument": "<n>" },
          { "name": "-t,--tab-delim" },
          { "name": "-O,--other-delim", "argument": "<char>" },
          { "name": "-q,--no-quote" },
          { "name": "-R,--skip-head", "argument": "<n>" },
          { "name": "-d,--header-row-span", "argument": "<n>" },
          { "name": "-u,--malformed-utf8-replacement", "argument": "<replacement_string>" },
          { "name": "-S,--keep-blank-headers" },
          { "name": "-0,--header-row", "argument": "<header>" },
          { "name": "-v,--verbose" },
        ],
        "commands": [
          {
            "name": "sql",
            "flags": [
              {
                "name": "--join-indexes",
                "argument": "<n1...>"
              },
              {
                "name": "-b"
              },
              {
                "name": "-C,--max-cols",
                "argument": "<n>"
              },
              {
                "name": "--memory"
              },
            ]
          },
          { "name": "count", "flags": [] },
          {
            "name": "desc",
            "flags": [
              {
                "name": "-b,--with-bom"
              },
              {
                "name": "-C",
                "argument": "<maximum_number_of_columns>"
              },
              {
                "name": "-H"
              },
              {
                "name": "-q,--quick"
              },
              {
                "name": "-a,--all"
              },
            ]
          },
          {
            "name": "pretty",
            "flags": [
              {
                "name": "-W,--width",
                "argument": "<n>"
              },
              {
                "name": "-p,--rows"
              },
              {
                "name": "-C,--max-col-width",
                "argument": "<n>"
              },
              {
                "name": "-D,--min-col-width",
                "argument": "<n>"
              },
              {
                "name": "-A,--no-align"
              },
              {
                "name": "-m,--markdown"
              },
              {
                "name": "-M,--markdown-pad"
              },
              {
                "name": "-H,--ignore-header-lengths"
              },
            ]
          },
          {
            "name": "2json",
            "flags": [
              {
                "name": "--compact"
              },
              {
                "name": "--from-db"
              },
              {
                "name": "--db-table",
                "argument": "<table_name>"
              },
              {
                "name": "--object"
              },
              {
                "name": "--no-empty"
              },
              {
                "name": "--database"
              },
              {
                "name": "--no-header"
              },
              {
                "name": "--index",
                "argument": "<name_on_expr>"
              },
              {
                "name": "--unique-index",
                "argument": "<name_on_expr>"
              },
            ]
          },
          {
            "name": "stack",
            "flags": [
              {
                "name": "-b"
              },
              {
                "name": "-q"
              },
              {
                "name": "-T"
              },
            ]
          },
          {
            "name": "compare",
            "flags": [
              {
                "name": "-k,--key",
                "argument": "<field>"
              },
              {
                "name": "-a,--add",
                "argument": "<field>"
              },
              {
                "name": "--sort"
              },
              {
                "name": "--sort-in-memory"
              },
              {
                "name": "--json"
              },
              {
                "name": "--json-compact"
              },
              {
                "name": "--json-object"
              },
            ]
          },
          {
            "name": "echo",
            "flags": [
              {
                "name": "-b"
              },
              {
                "name": "--overwrite",
                "argument": "<source>"
              },
            ]
          },
          {
            "name": "flatten",
            "flags": [
              {
                "name": "-b"
              },
              {
                "name": "-v,--verbose"
              },
              {
                "name": "-C",
                "argument": "<max_columns_to_output>"
              },
              {
                "name": "-m",
                "argument": "<max_rows_per_aggregation>"
              },
              {
                "name": "--row-id",
                "argument": "<row_id_column_name>"
              },
              {
                "name": "--col-name",
                "argument": "<column_id_column_name>"
              },
              {
                "name": "-V",
                "argument": "<value_column_name>"
              },
            ]
          },
          { "name": "2tsv", "flags": [] },
          {
            "name": "serialize",
            "flags": [
              {
                "name": "-b"
              },
              {
                "name": "-f,--filter",
                "argument": "<value>"
              },
              {
                "name": "-e,--entire"
              },
              {
                "name": "-i,--case-insensitive"
              },
              {
                "name": "-p,--position"
              },
              {
                "name": "-a,--add",
                "argument": "<column_name>"
              },
            ]
          },
          {
            "name": "select",
            "flags": [
              {
                "name": "-b,--with-bom"
              },
              {
                "name": "--fixed",
                "argument": "<offset1,offset2,..>"
              },
              {
                "name": "--fixed-auto"
              },
              {
                "name": "-H,--head",
                "argument": "<n>"
              },
              {
                "name": "-s,--search",
                "argument": "<value>"
              },
              {
                "name": "--sample-every",
                "argument": "<num_of_rows>"
              },
              {
                "name": "--sample-pct",
                "argument": "<percentage>"
              },
              {
                "name": "--distinct"
              },
              {
                "name": "--merge"
              },
              {
                "name": "-e",
                "argument": "<embedded_lineend_char>"
              },
              {
                "name": "-x",
                "argument": "<column>"
              },
              {
                "name": "-N,--line-number"
              },
              {
                "name": "-n"
              },
              {
                "name": "--unescape"
              },
              {
                "name": "-w,--whitespace-clean"
              },
              {
                "name": "--whitespace-clean-no-newline"
              },
              {
                "name": "-W,--no-trim"
              },
            ]
          },
        ]
      }
    };

    function updateCommands(event) {
      document.getElementById("commands").innerHTML = "";
      document.getElementById("flags").innerHTML = "";
      document.getElementById("cli").innerHTML = "zsv";
      const version = document.getElementById("version").value;
      if (zsv[version] !== undefined) {
        const commands = zsv[version]["commands"];
        if (commands.length !== 0) {
          var commandsHTML = [
            "<option value='' selected>Select command</option>",
          ];
          for (let command of commands) {
            commandsHTML.push(`"<option value='${command.name}'>${command.name}</option>"`);
          }
          document.getElementById("commands").innerHTML = commandsHTML.join("");
        }
      }
    }

    function normalizeFlagName(name) {
      return name.replace(/-|,/g, "");
    }

    function updateFlags(command) {
      const version = document.getElementById("version").value;
      if (version === "") {
        document.getElementById("flags").innerHTML = "";
        return;
      }

      var flagsHTML = [];
      const globalFlags = zsv[version]["global_flags"];
      for (let flag of globalFlags) {
        const id = normalizeFlagName(flag.name);
        f = `
          <div class="input-group mb-0">
            <div class="input-group-text">
              <input id="flag_${id}" value="${flag.name}" class="form-check-input" type="checkbox" onchange="updateCliWithFlags(event);" />
            </div>
            <span class="form-control input-group-text w-50">${flag.name}</span>
        `;
        if (flag.argument !== undefined) {
          f += `<input id="flag_${id}_value" type="text" class="form-control" placeholder="${flag.argument}" />`;
        }
        f += '</div>';
        flagsHTML.push(f);
      }

      const commands = zsv[version]["commands"];
      for (let flag of commands.find(cmd => cmd.name === command)["flags"]) {
        const id = normalizeFlagName(flag.name);
        var f = `
          <div class="input-group mb-0">
            <div class="input-group-text">
              <input id="flag_${id}" value="${flag.name}" class="form-check-input" type="checkbox" onchange="updateCliWithFlags(event);" />
            </div>
            <span class="form-control input-group-text w-50">${flag.name}</span>
        `;
        if (flag.argument !== undefined) {
          f += `<input id="flag_${id}_value" type="text" class="form-control" placeholder="${flag.argument}" />`;
        }
        f += '</div>';
        flagsHTML.push(f);
      }
      document.getElementById("flags").innerHTML = flagsHTML.join("");
    }

    function updateCLI(command) {
      document.getElementById("cli").value = "zsv " + command;
    }

    function updateFlagsAndCLI() {
      const command = document.getElementById("commands").value;
      if (command === "") {
        document.getElementById("flags").innerHTML = "";
        document.getElementById("cli").value = "zsv";
        return;
      }
      updateCLI(command);
      updateFlags(command);
    }

    function updateCliWithFlags(event) {
      const flagId = event.target.id;
      const flagName = event.target.value;
      const flagValue = document.getElementById(flagId + "_value");

      var flag = flagName;
      if (flag.indexOf(",") !== -1) {
        flag = flag.substring(0, flag.indexOf(","));
      }

      var value = "";
      if (flagValue !== null) {
        if (flagValue.value !== "") {
          value = `'${flagValue.value}'`;
        } else {
          value = `''`;
        }
      }

      var cli = document.getElementById("cli").value.split(" ");
      if (event.target.checked === true) {
        if (value === "") {
          cli.push(flag);
        } else {
          const i = cli.indexOf(flag);
          if (i === -1) {
            cli.push(flag, value);
          } else {
            cli.splice(i + 1, 0, value);
          }
        }
      } else {
        const i = cli.indexOf(flag);
        if (value === "") {
          cli.splice(i, 1);
        } else {
          cli.splice(i, 2);
        }
      }
      document.getElementById("cli").value = cli.join(" ");
    }

  </script>
  <title>zsv playground v0.0.1</title>
</head>

<body class="p-3 mt-3 font-monospace">
  <div class="container">
    <div class="text-center text-bg-primary rounded-2 fs-3">
      zsv playground
      <span class="badge badge-dark">v0.0.1</span>
    </div>

    <!-- version -->
    <div class="row mt-4 mb-4 text-center">
      <div class="col-12">
        <select id="version" class="form-select w-25 mx-auto text-center" required onchange="updateCommands(event);">
          <option value="" selected>Select zsv version</option>
          <option value="v0.3.8-alpha">zsv v0.3.8-alpha</option>
          <option value="v0.3.7-alpha">zsv v0.3.7-alpha</option>
          <option value="v0.3.6-alpha">zsv v0.3.6-alpha</option>
        </select>
      </div>
    </div>

    <form class="form" action="#">
      <div class="row mb-3 flex-nowrap">
        <!-- commands -->
        <div class="col-3">
          <select id="commands" class="form-select overflow-auto" size="7" required onchange="updateFlagsAndCLI();">
          </select>
        </div>

        <!-- flags -->
        <div class="col-9">
          <div id="flags" class="list-group overflow-auto p-2 border" style="max-height: 150px; height: 150px;">
            <!-- <div class="input-group">
              <div class="input-group-text">
                <input id="flag_Bboolean" class="form-check-input" type="checkbox" value="-B,--boolean"
                  onchange="updateCliWithFlags(event);" />
              </div>
              <span class="form-control input-group-text">-B,--boolean</span>
            </div>
            <div class="input-group mb-3">
              <div class="input-group-text">
                <input id="flag_Vvalue" class="form-check-input" type="checkbox" value="-V,--value"
                  onchange="updateCliWithFlags(event);" />
              </div>
              <span class="form-control input-group-text w-50">-V,--value</span>
              <input id="flag_Vvalue_value" type="text" class="form-control" placeholder="value" />
            </div> -->
          </div>
        </div>
      </div>

      <!-- cli -->
      <div class="row">
        <div class="input-group">
          <input id="cli" type="text" class="form-control bg-light" value="zsv" readonly />
          <button id="run" class="btn btn-outline-primary" type="submit">Run</button>
        </div>
      </div>

      <!-- input and output -->
      <div class="row mt-3">
        <div class="col">
          <label for="csv" class="form-label">CSV</label>
          <textarea id="csv" class="form-control" required></textarea>
        </div>
        <div class="col">
          <label for="result" class="form-label">Result</label>
          <textarea id="result" class="form-control" readonly></textarea>
        </div>
      </div>
    </form>
  </div>
</body>

</html>
